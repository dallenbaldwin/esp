<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>ESP</title>
      <!-- CSS only -->
      <link
         rel="stylesheet"
         href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css"
         integrity="sha384-r4NyP46KrjDleawBgD5tp8Y7UzmLA05oM1iAEQ17CSuDqnUK2+k9luXQOfXJCJ4I"
         crossorigin="anonymous"
      />
      <style>
         .c-card {
            border-style: solid;
            border-radius: 2em;
            border-width: 3px;
            border-color: black;
            margin: auto;
            /* aspect ratio of playing card = 5 : 7 */
            width: 300px;
            height: 420px;
         }
         #cardBack > div {
            margin: auto;
            font-size: 12em;
            text-align: center !important;
            vertical-align: middle !important;
         }
         .c-star {
            color: #25c52d;
            font-size: 350px;
            position: absolute;
            top: -40px;
            z-index: -1;
         }
         .c-square {
            color: black;
            font-size: 500px;
            position: absolute;
            top: -210px;
            left: 36.4999px;
            z-index: -1;
         }
         .c-circle {
            color: #f6c803;
            font-size: 250px;
            position: absolute;
            left: 47.235px;
            z-index: -1;
         }
         .c-waves {
            color: #064ef6;
            font-size: 275px;
            letter-spacing: -50px;
            position: absolute;
            left: 100px;
            top: 30px;
            z-index: -1;
         }
         .c-plus {
            color: #fe0000;
            font-size: 530px;
            position: absolute;
            left: 6.215px;
            top: -215px;
            z-index: -1;
         }
      </style>
   </head>
   <body>
      <div class="container">
         <!-- for some reason toggling modals doesn't work in BS5 yet?? -->
         <button
            type="button"
            class="btn btn-primary d-none"
            data-toggle="modal"
            id="gameOverBtn"
            data-target="#gameOverModal"
         >
            Launch game over
         </button>
         <!-- end of the game modal -->
         <div
            class="modal fade"
            id="gameOverModal"
            data-backdrop="static"
            data-keyboard="false"
            tabindex="-1"
            aria-labelledby="gameOverModalLabel"
            aria-hidden="true"
         >
            <div class="modal-dialog modal-dialog-centered">
               <div class="modal-content" style="min-height: 400px">
                  <div class="modal-header">
                     <h5 class="modal-title" id="gameOverModalLabel">Game Over</h5>
                  </div>
                  <div class="modal-body" id="gameOverModalBody"></div>
                  <div class="modal-footer">
                     <button
                        type="button"
                        class="btn btn-primary btn-lg c-start-the-game"
                        data-dismiss="modal"
                     >
                        Play Again
                     </button>
                     <button
                        type="button"
                        class="btn btn-warning btn-lg c-end-the-game"
                        data-dismiss="modal"
                     >
                        Exit
                     </button>
                  </div>
               </div>
            </div>
         </div>
         <!-- exit game modal -->
         <div
            class="modal fade"
            id="exitModal"
            data-backdrop="static"
            data-keyboard="false"
            tabindex="-1"
            aria-labelledby="exitModalLabel"
            aria-hidden="true"
         >
            <div class="modal-dialog modal-dialog-centered">
               <div class="modal-content" style="min-height: 400px">
                  <div class="modal-header">
                     <h5 class="modal-title" id="exitModalLabel">WAIT!</h5>
                  </div>
                  <div class="modal-body" id="exitModalBody">
                     <p>Are you sure you want to exit the game?</p>
                     <p>You may never know you have Extra Sensory Perception!</p>
                  </div>
                  <div class="modal-footer">
                     <button
                        type="button"
                        class="btn btn-primary btn-lg"
                        data-dismiss="modal"
                     >
                        Continue
                     </button>
                     <button
                        type="button"
                        class="btn btn-warning btn-lg c-end-the-game"
                        data-dismiss="modal"
                     >
                        Stop
                     </button>
                  </div>
               </div>
            </div>
         </div>
         <div class="row mt-5">
            <div class="col-sm"></div>
            <div class="col-sm">
               <div class="c-card text-center">
                  <div id="cardBack">
                     <div>ðŸ‘»</div>
                     <h3 id="guessCount"></h3>
                     <h2 id="guessRatio"></h2>
                  </div>
                  <div id="cardFront" class="text-center"></div>
               </div>
            </div>
            <div class="col-sm"></div>
         </div>
         <div class="row mt-3">
            <div class="col-sm">
               <div id="welcomeMessage">
                  <p>
                     ESP, or Extrasensory Perception, and whether you have it, is the goal
                     of this experiment.
                  </p>
                  <p>Are you ready?</p>
               </div>
               <div class="text-center">
                  <button
                     id="startBtn"
                     type="button"
                     class="btn btn-primary btn-lg c-start-the-game"
                  >
                     Let us Begin
                  </button>
                  <button id="continueBtn" type="button" class="btn btn-secondary btn-lg">
                     Continue
                  </button>
                  <button
                     id="exitBtn"
                     type="button"
                     class="btn btn-warning btn-lg"
                     data-toggle="modal"
                     data-target="#exitModal"
                  >
                     Exit
                  </button>
               </div>
            </div>
         </div>
      </div>
      <!-- JavaScript and dependencies -->
      <script
         src="https://code.jquery.com/jquery-3.5.1.min.js"
         integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
         crossorigin="anonymous"
      ></script>
      <script
         src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
         integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
         crossorigin="anonymous"
      ></script>
      <script
         src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/js/bootstrap.min.js"
         integrity="sha384-oesi62hOLfzrys4LxRF63OJCXdXDipiYWBnvTl9Y9/TRlw5xlKIEHpNyvvDShgf/"
         crossorigin="anonymous"
      ></script>
      <script
         src="https://cdn.jsdelivr.net/npm/lodash@4.17.20/lodash.min.js"
         integrity="sha256-ur/YlHMU96MxHEsy3fHGszZHas7NzH4RQlD4tDVvFhw="
         crossorigin="anonymous"
      ></script>
      <!-- Library for speech recognition: https://www.talater.com/annyang/ -->
      <script src="//cdnjs.cloudflare.com/ajax/libs/annyang/2.6.0/annyang.min.js"></script>
      <!-- custom scripts -->
      <script>
         const TOTALGUESS = 25;
         // cards
         let star = {
            name: 'star',
            symbol: `<div class="c-star">â˜†</div>`,
         };
         let circle = {
            name: 'circle',
            symbol: `<div class="c-circle">â—¯</div>`,
         };
         let plus = {
            name: 'plus',
            symbol: `<div class="c-plus">+</div>`,
         };
         let square = {
            name: 'square',
            symbol: `<div class="c-square">â–¡</div>`,
         };
         let waves = {
            name: 'waves',
            symbol: `<div class="c-waves">&#8967&#8967&#8967</div>`,
         };

         // init and fill deck
         const DECK = Array(25);
         DECK.fill(star, 0, 5);
         DECK.fill(circle, 6, 10);
         DECK.fill(plus, 11, 15);
         DECK.fill(square, 16, 20);
         DECK.fill(waves, 21, 25);

         // important variables
         const db = window.localStorage;
         if (!db.getItem('guessCount')) db.setItem('guessCount', '0');
         if (!db.getItem('correctGuess')) db.setItem('correctGuess', '0');

         function updateGuesses() {
            let remainingGuesses = TOTALGUESS - Number(db.getItem('guessCount'));
            $('#guessCount')
               .empty()
               .text(`Of ${TOTALGUESS} guesses, ${remainingGuesses} remain.`);
            $('#guessRatio')
               .empty()
               .text(`${db.getItem('correctGuess')} guessed correctly...`);
         }

         function shuffleDeck() {
            let shuffled;
            // for some reason _.shuffle() returns an undefined list every once and a while... don't know why
            while (!shuffled) shuffled = _.shuffle(DECK).shift();
            return shuffled;
         }

         function sendCommand(phrase) {
            let thing = new SpeechSynthesisUtterance(phrase);
            window.speechSynthesis.speak(thing);
         }

         function flipFront(card) {
            $('#cardFront').empty().append(`<div>${card.symbol}</div>`);
            $('#cardBack').hide(1000, function () {
               $('#cardFront').show(1000);
            });
         }

         function flipBack() {
            $('#cardFront').hide(1000, function () {
               $('#cardBack').show(1000);
            });
         }

         function ZhuLi_DoTheThing(guesses) {
            guesses = guess.map(x => x.toLowerCase());
            console.log(guesses);
            annyang.pause();
            let correct = shuffleDeck();
            let guessed = Number(db.getItem('correctGuess'));
            let count = Number(db.getItem('guessCount'));
            count++;
            db.setItem('guessCount', count);
            if (guesses.contains(correct.name)) {
               guessed++;
               db.setItem('correctGuess', guessed.toString());
               sendCommand(`That is correct. `);
            } else {
               sendCommand(`That is incorrect. The correct symbol was ${correct.name}.`);
            }
            sendCommand(
               `You have guessed ${guessed} card${guessed == 1 ? '' : 's'} correctly`
            );
            flipFront(correct);
            if (count >= TOTALGUESS) {
               setTimeout(() => {
                  finishTheGame();
               }, 7000);
               return;
            } else {
               sendCommand(
                  ` If you'd like to continue, click Continue, otherwise, click exit`
               );
               setTimeout(() => {
                  $('#continueBtn').show(1000);
               }, 9000);
            }
         }

         function finishTheGame() {
            let correct = Number(db.getItem('correctGuess'));
            $('#gameOverModalBody').empty().append(`<p>
               You managed to guess ${correct} card${correct === 1 ? '' : 's'}.
            </p>`);
            if (correct >= 11) {
               sendCommand(`It appears you have an affinity for the supernatural.`);
               sendCommand(`Perhaps a career in Ghost-busting is in your future.`);
            } else {
               sendCommand(`Some people just don't have it.`);
               sendCommand(`At least you don't have to worry about seeing dead people.`);
            }
            $('#gameOverBtn').click();
         }

         function startGame() {
            annyang.start({ paused: true });
            resetTheGame();
            $('#welcomeMessage').hide(1000);
            $('#startBtn').hide(1000);
            $('#exitBtn').show(1000);
            // send init voice
            sendCommand(`I'm going to test you for extra sensory power.`);
            sendCommand(
               `On the back of this card is a circle, plus, waves, square, or star.`
            );
            sendCommand('Clear your mind.');
            sendCommand(
               `When you're ready, say out loud which symbol is on the back of the card.`
            );
            // wait for response
            annyang.resume();
         }

         function resetTheGame() {
            window.speechSynthesis.cancel();
            annyang.abort();
            db.setItem('correctGuess', '0');
            db.setItem('guessCount', '0');
            updateGuesses();
            flipBack();
            $('#exitBtn').hide(1000);
            $('#continueBtn').hide(1000);
            $('#startBtn').show(1000);
            $('#welcomeMessage').show(1000);
         }

         function continueGame() {
            window.speechSynthesis.cancel();
            $('#welcomeMessage').hide(1000);
            $('#continueBtn').hide(1000);
            // update guess display
            updateGuesses();
            // flip the card back
            flipBack();
            // send follow up response
            sendCommand(`Let us continue. The deck has been shuffled.`);
            sendCommand(`Clear your mind.`);
            sendCommand(
               `When you're ready, say out loud which symbol is on the back of the card.`
            );
            // wait for response
            annyang.resume();
         }

         $(document).ready(() => {
            if (Number(db.getItem('guessCount')) > 0) {
               $('#startBtn').hide();
               $('#continueBtn').show();
               $('#exitBtn').show();
            } else {
               $('#startBtn').show();
               $('#continueBtn').hide();
               $('#exitBtn').hide();
            }
            $('.c-start-the-game').click(startGame);
            $('#continueBtn').click(continueGame);
            $('.c-end-the-game').click(resetTheGame);
            updateGuesses();
            // speech initialization
            if (annyang) {
               // annyang.debug(true);
               // Define commands. First the text we expect, and then the function it should call
               let command = {
                  ':symbol (sign)': ZhuLi_DoTheThing,
               };
               // Add our command to annyang
               annyang.addCommands(command);
               annyang.addCallback('result', function (phrases) {
                  console.log('I think the user said: ', phrases[0]);
                  console.log(
                     'But then again, it could be any of the following: ',
                     phrases
                  );
               });
            }
         });
      </script>
   </body>
</html>
